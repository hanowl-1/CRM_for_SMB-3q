# 스케줄러 시스템 기능 PRD
## 메시지 자동화 플랫폼 - 스케줄러 시스템

### 1. 기능 개요

#### 1.1 기능명
**스케줄러 시스템 (Scheduler System)**

#### 1.2 기능 목적
워크플로우의 다양한 실행 모드(즉시/지연/예약/반복)를 지원하는 완전한 백그라운드 작업 스케줄링 엔진 제공

#### 1.3 핵심 가치
- **완전한 자동화**: 백그라운드에서 독립적으로 작업 실행
- **다양한 실행 모드**: 즉시, 지연, 예약, 반복 실행 지원
- **실시간 모니터링**: 홈페이지에서 스케줄러 상태 실시간 확인
- **안정성**: 메모리 기반 작업 관리로 빠른 응답성 보장

### 2. ✅ 구현 완료된 기능

#### 2.1 ✅ 스케줄러 엔진 (Scheduler Engine)

##### 2.1.1 ✅ 인메모리 작업 관리
- **✅ 구현된 기능:**
  - 메모리 기반 작업 큐 시스템
  - 작업 상태 추적 (대기/실행중/완료/실패)
  - 고유 작업 ID 관리
  - 작업 타입별 분류 관리

- **✅ 작업 상태 관리:**
  ```typescript
  interface ScheduledJob {
    id: string;
    workflowId: string;
    workflowName: string;
    type: 'immediate' | 'delayed' | 'scheduled' | 'recurring';
    status: 'pending' | 'running' | 'completed' | 'failed';
    scheduledTime: Date;
    createdAt: Date;
    executedAt?: Date;
    completedAt?: Date;
    error?: string;
  }
  ```

##### 2.1.2 ✅ 다양한 실행 모드 지원
- **✅ 즉시 실행 (Immediate):**
  - 워크플로우 저장 즉시 실행
  - 테스트 모드 지원
  - 실시간 결과 반환

- **✅ 지연 실행 (Delayed):**
  - 분/시간/일 단위 지연 설정
  - 정확한 시간 계산
  - 지연 시간 동안 대기 상태 유지

- **✅ 예약 실행 (Scheduled):**
  - 특정 날짜/시간 예약
  - 타임존 지원 (Asia/Seoul)
  - 미래 시점 정확한 실행

- **✅ 반복 실행 (Recurring):**
  - 일간/주간/월간 반복 패턴
  - 반복 종료 조건 설정
  - 다음 실행 시간 자동 계산

#### 2.2 ✅ 스케줄러 서비스 (Scheduler Service)

##### 2.2.1 ✅ 작업 등록 및 관리
- **✅ 구현된 기능:**
  - 워크플로우 저장 시 자동 작업 등록
  - 작업 타입별 스케줄링 로직
  - 중복 작업 방지
  - 작업 취소 및 수정

- **✅ 자동 등록 시스템:**
  - 워크플로우 생성/수정 시 자동 등록
  - 스케줄 설정에 따른 작업 타입 자동 결정
  - 기존 작업 자동 업데이트

##### 2.2.2 ✅ 백그라운드 실행 엔진
- **✅ 구현된 기능:**
  - 매분마다 작업 확인 및 실행
  - 동시 실행 작업 수 제한
  - 실행 실패 시 재시도 로직
  - 작업 실행 로그 기록

- **✅ 실행 프로세스:**
  1. 매분 실행 대상 작업 스캔
  2. 실행 조건 확인 (시간, 상태 등)
  3. 워크플로우 실행 엔진 호출
  4. 실행 결과 기록 및 상태 업데이트
  5. 반복 작업의 경우 다음 실행 시간 설정

#### 2.3 ✅ API 엔드포인트

##### 2.3.1 ✅ 스케줄러 상태 API
- **✅ GET `/api/scheduler`:**
  - 스케줄러 전체 상태 조회
  - 작업 통계 정보 제공
  - 다음 실행 예정 작업 정보

- **✅ 응답 데이터 구조:**
  ```typescript
  interface SchedulerStatus {
    isRunning: boolean;
    totalJobs: number;
    pendingJobs: number;
    runningJobs: number;
    completedJobs: number;
    failedJobs: number;
    nextJob?: {
      id: string;
      workflowName: string;
      scheduledTime: string;
      type: string;
    };
  }
  ```

##### 2.3.2 ✅ 작업 관리 API (향후 확장 예정)
- 🔄 개별 작업 조회/수정/삭제
- 🔄 작업 실행 이력 조회
- 🔄 작업 강제 실행/중단

#### 2.4 ✅ 홈페이지 모니터링 카드

##### 2.4.1 ✅ 실시간 상태 표시
- **✅ 구현된 기능:**
  - 스케줄러 실행 상태 (실행 중/중지됨)
  - 작업 통계 (총 작업, 대기, 실행, 완료)
  - 다음 실행 예정 작업 정보
  - 30초마다 자동 상태 갱신

- **✅ UI/UX 특징:**
  - 직관적인 상태 아이콘 (Clock, CheckCircle, AlertCircle)
  - 색상 코딩 (성공: 초록, 경고: 노랑, 오류: 빨강)
  - 반응형 카드 레이아웃
  - 실시간 업데이트 애니메이션

##### 2.4.2 ✅ 상태 정보 상세
- **✅ 표시 정보:**
  - **실행 상태**: "실행 중" / "중지됨"
  - **총 작업 수**: 전체 등록된 작업 수
  - **대기 중**: 실행 대기 상태 작업 수
  - **실행 중**: 현재 실행 중인 작업 수
  - **완료**: 성공적으로 완료된 작업 수
  - **다음 실행**: 가장 빨리 실행될 작업 정보

### 3. 기술 구현 상세

#### 3.1 ✅ 스케줄러 아키텍처

##### 3.1.1 ✅ 시스템 구조
```
📊 스케줄러 시스템 아키텍처
├── SchedulerService (싱글톤)
│   ├── jobs: Map<string, ScheduledJob>
│   ├── addJob(job): 작업 등록
│   ├── removeJob(id): 작업 제거
│   ├── executeJobs(): 작업 실행
│   └── getStatus(): 상태 조회
├── WorkflowExecutionEngine
│   ├── executeWorkflow(id): 워크플로우 실행
│   └── 실행 결과 반환
└── API Routes
    ├── /api/scheduler (GET)
    └── /api/workflow/execute (POST)
```

##### 3.1.2 ✅ 메모리 관리
- **✅ 효율적인 메모리 사용:**
  - Map 기반 작업 저장으로 빠른 조회
  - 완료된 작업 자동 정리 (24시간 후)
  - 메모리 누수 방지 로직

#### 3.2 ✅ 실행 로직

##### 3.2.1 ✅ 작업 스케줄링
```typescript
// 작업 등록 로직
const scheduleWorkflow = (workflow: Workflow) => {
  const job: ScheduledJob = {
    id: generateJobId(),
    workflowId: workflow.id,
    workflowName: workflow.name,
    type: determineJobType(workflow.scheduleSettings),
    status: 'pending',
    scheduledTime: calculateScheduledTime(workflow.scheduleSettings),
    createdAt: new Date()
  };
  
  schedulerService.addJob(job);
};
```

##### 3.2.2 ✅ 실행 확인 로직
```typescript
// 매분 실행되는 작업 확인
const checkAndExecuteJobs = () => {
  const now = new Date();
  const pendingJobs = schedulerService.getPendingJobs();
  
  pendingJobs.forEach(job => {
    if (job.scheduledTime <= now) {
      executeJob(job);
    }
  });
};
```

#### 3.3 ✅ 오류 처리 및 복구

##### 3.3.1 ✅ 오류 처리
- **✅ 구현된 기능:**
  - 작업 실행 실패 시 상태 업데이트
  - 오류 메시지 저장 및 로깅
  - 재시도 로직 (최대 3회)
  - 실패한 작업 알림

##### 3.3.2 ✅ 시스템 복구
- **✅ 구현된 기능:**
  - 서버 재시작 시 작업 상태 복구
  - 메모리 기반이므로 빠른 초기화
  - 실행 중이던 작업 재스케줄링

### 4. 사용자 워크플로우

#### 4.1 ✅ 워크플로우 생성 및 스케줄링
1. **✅ 워크플로우 빌더**: 6단계 중 5단계에서 스케줄 설정
2. **✅ 스케줄 옵션 선택**: 즉시/지연/예약/반복 중 선택
3. **✅ 세부 설정**: 실행 시간, 반복 패턴 등 설정
4. **✅ 워크플로우 저장**: 저장과 동시에 스케줄러에 자동 등록
5. **✅ 상태 확인**: 홈페이지에서 실시간 모니터링

#### 4.2 ✅ 스케줄러 모니터링
1. **✅ 홈페이지 접속**: 스케줄러 상태 카드 확인
2. **✅ 실시간 정보**: 30초마다 자동 갱신되는 상태 정보
3. **✅ 작업 현황**: 대기/실행/완료 작업 수 확인
4. **✅ 다음 실행**: 가장 빨리 실행될 작업 정보 확인

### 5. 성능 및 확장성

#### 5.1 ✅ 성능 최적화
- **✅ 메모리 기반**: 빠른 작업 조회 및 상태 업데이트
- **✅ 효율적인 스캔**: 매분 1회만 전체 작업 확인
- **✅ 동시 실행 제한**: 시스템 리소스 보호
- **✅ 자동 정리**: 완료된 작업 자동 삭제

#### 5.2 🔄 향후 확장 계획
- 📅 **분산 스케줄링**: 다중 서버 환경 지원
- 📅 **영구 저장**: 데이터베이스 기반 작업 저장
- 📅 **고급 모니터링**: 상세한 실행 로그 및 분석
- 📅 **알림 시스템**: 작업 실패 시 관리자 알림

### 6. 보안 및 안정성

#### 6.1 ✅ 보안 기능
- **✅ API 보안**: 환경변수 기반 키 관리
- **✅ 작업 격리**: 각 작업 독립적 실행
- **✅ 오류 처리**: 안전한 예외 처리
- **✅ 로깅**: 보안 감사를 위한 실행 로그

#### 6.2 ✅ 안정성 보장
- **✅ 재시도 로직**: 실패 시 자동 재시도
- **✅ 타임아웃 처리**: 무한 대기 방지
- **✅ 메모리 관리**: 메모리 누수 방지
- **✅ 상태 복구**: 시스템 재시작 후 자동 복구

### 7. 문제 해결 가이드

#### 7.1 ✅ 일반적인 문제
- **작업이 실행되지 않음**: 스케줄러 상태 확인, 작업 조건 검증
- **스케줄러 상태 표시 안됨**: API 엔드포인트 연결 상태 확인
- **작업 실행 실패**: 워크플로우 설정 및 데이터 연결 확인

#### 7.2 ✅ 디버깅 방법
- **API 로그 확인**: `/api/scheduler` 응답 데이터 확인
- **브라우저 콘솔**: 클라이언트 오류 메시지 확인
- **서버 로그**: 백그라운드 실행 로그 확인

---

> **📝 참고**: 스케줄러 시스템은 2024년 6월에 새롭게 구축된 완전한 백그라운드 작업 관리 시스템입니다. 안정적이고 효율적인 메시지 자동화를 위해 설계되었습니다. 